<!doctype html>
<meta charset="utf-8">
<title>JSON → WebVTT (YouTube transcript)</title>
<style>
  :root { --border:#c7cdd3; --accent:#7aa7ff33; --text:#222; --muted:#666; }
  html,body { height:100%; margin:0; font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); }
  .wrap { max-width:1200px; margin:28px auto; padding:0 16px; display:grid; gap:20px; grid-template-columns:1fr 1fr; }
  .drop {
    border:3px dashed var(--border); border-radius:18px; background:#eaf4ff;
    min-height:360px; display:flex; align-items:center; justify-content:center; text-align:center;
    padding:24px; color:#3a4a5a; position:relative; transition:150ms ease;
  }
  .drop.dragover { background:#dff0ff; border-color:#7aa7ff; box-shadow:0 0 0 4px var(--accent) inset; }
  .drop strong { font-size:32px; opacity:.9; }
  .drop small { display:block; color:var(--muted); margin-top:8px; }
  .drop input[type="file"] { position:absolute; inset:0; opacity:0; cursor:pointer; }
  .panel { border:1px solid var(--border); border-radius:12px; padding:12px; display:flex; flex-direction:column; min-height:360px; }
  .panel h2 { font-size:14px; margin:0 0 8px; color:var(--muted); letter-spacing:.04em; text-transform:uppercase; }
  textarea { flex:1; width:100%; resize:vertical; min-height:320px; font:13px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre; }
  .row { display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }
  button, .btn {
    border:1px solid var(--border); background:#fff; border-radius:8px; padding:8px 12px; cursor:pointer;
    text-decoration:none; color:inherit;
  }
  .meta { font-size:12px; color:var(--muted); margin-left:auto; }
</style>

<div class="wrap">
  <label class="drop" id="drop">
    <div>
      <strong>Drop JSON file</strong>
      <small>…or click to choose</small>
    </div>
    <input id="file" type="file" accept=".json,application/json">
  </label>

  <div class="panel">
    <h2>WEBVTT</h2>
    <textarea id="out" placeholder="The VTT will appear here…" spellcheck="false"></textarea>
    <div class="row">
      <a id="download" class="btn" download="captions.vtt" hidden>Download .vtt</a>
      <button id="copy" hidden>Copy to clipboard</button>
      <span id="stats" class="meta"></span>
    </div>
  </div>
</div>

<script>
const drop = document.getElementById('drop');
const fileInput = document.getElementById('file');
const out = document.getElementById('out');
const dl = document.getElementById('download');
const copyBtn = document.getElementById('copy');
const stats = document.getElementById('stats');

// drag & drop visuals
['dragenter','dragover'].forEach(ev =>
  drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.add('dragover'); })
);
['dragleave','drop'].forEach(ev =>
  drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.remove('dragover'); })
);
drop.addEventListener('drop', e => {
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) handleFile(f);
});
fileInput.addEventListener('change', e => {
  const f = e.target.files && e.target.files[0];
  if (f) handleFile(f);
});

function handleFile(file) {
  const reader = new FileReader();
  reader.onerror = () => alert('Could not read file.');
  reader.onload = () => {
    try {
      const json = JSON.parse(reader.result);
      const { vtt, cueCount, skipped, durationMs } = jsonToVtt(json);
      out.value = vtt;
      const blob = new Blob([vtt], { type: 'text/vtt' });
      const url = URL.createObjectURL(blob);
      dl.href = url;
      dl.download = (file.name.replace(/\.[^.]+$/, '') || 'captions') + '.vtt';
      dl.hidden = false;
      copyBtn.hidden = false;
      stats.textContent = `${cueCount} cues · ${skipped} blank removed · ${formatMs(durationMs)} total`;
    } catch (err) {
      console.error(err);
      alert('That JSON was not recognized (needs an "events" array).');
    }
  };
  reader.readAsText(file);
}

copyBtn.addEventListener('click', async () => {
  try {
    await navigator.clipboard.writeText(out.value);
    copyBtn.textContent = 'Copied!';
    setTimeout(() => copyBtn.textContent = 'Copy to clipboard', 1200);
  } catch {
    alert('Could not copy.');
  }
});

// ---- Conversion ----
function jsonToVtt(data) {
  if (!data || !Array.isArray(data.events)) throw new Error('No events[] array');

  let lines = ['WEBVTT', ''];
  let cueCount = 0, skipped = 0, lastEnd = 0;

  for (const ev of data.events) {
    const start = toNumber(ev.tStartMs);
    const dur = toNumber(ev.dDurationMs);
    if (start == null || dur == null) continue;

    const end = start + dur;
    const text = extractText(ev).trim();

    if (!text) { skipped++; continue; }  // skip blank cues

    cueCount++;
    lines.push(String(cueCount));
    lines.push(timecode(start) + ' --> ' + timecode(end));
    lines.push(text);
    lines.push('');
    lastEnd = Math.max(lastEnd, end);
  }

  return { vtt: lines.join('\n'), cueCount, skipped, durationMs: lastEnd };
}

function extractText(ev) {
  if (Array.isArray(ev.segs)) return ev.segs.map(s => s?.utf8 ?? '').join('');
  if (typeof ev.text === 'string') return ev.text;
  if (typeof ev.utf8 === 'string') return ev.utf8;
  return '';
}

function toNumber(x) {
  const n = Number(x);
  return Number.isFinite(n) ? n : null;
}

function timecode(ms) {
  const h = Math.floor(ms / 3600000);
  const m = Math.floor((ms % 3600000) / 60000);
  const s = Math.floor((ms % 60000) / 1000);
  const f = Math.floor(ms % 1000);
  return `${pad(h)}:${pad(m)}:${pad(s)}.${String(f).padStart(3,'0')}`;
}

function pad(n){ return String(n).padStart(2,'0'); }
function formatMs(ms) {
  const sec = Math.round(ms/1000);
  const m = Math.floor(sec/60), s = sec%60;
  return `${m}:${String(s).padStart(2,'0')}`;
}
</script>
